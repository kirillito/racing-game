<html>
<head></head>
<body>
	<canvas id="gameCanvas" width="800" height="640"></canvas>
	<p	id="debugText"></p>
	<script>
		var canvas;
		var canvasContext;

		const TOP_INFO_HEIGHT = 20

		const	KEY_UP_ARROW	= 38;
		const	KEY_DOWN_ARROW	= 40;
		const	KEY_LEFT_ARROW	= 37;
		const	KEY_RIGHT_ARROW	= 39;
		var	keyHeld_Gas	= false;
		var	keyHeld_Reverse	= false;
		var	keyHeld_TurnLeft	= false;
		var	keyHeld_TurnRight	= false;

		var carX = 50;
		var carY = 50;
		var carSpeed = 0;
		var carAngle = 0;
		var carPic = new Image();
		var carPicLoaded = false;
		var DRIVE_POWER = 0.4;
		var REVERSE_POWER = 0.2;
		var TURN_RATE = 0.02;
		var MIN_TURN_SPEED = 0.6;
		var GROUNDSPEED_DECAY_MULT = 0.94;
		
		const TRACK_W = 40;
		const TRACK_H = 40;
		const TRACK_GAP = 1;
		const TRACK_COLS = 20;
		const TRACK_ROWS = 15;
		const	TRACK_CODE_ROAD = 0;
		const	TRACK_CODE_WALL = 1;
		const	TRACK_CODE_PLAYER = 2;
		var trackGrid = 
		[	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,
			1,	2,	0,	0,	0,	0,	0,	0,	1,	1,	1,	0,	0,	0,	0,	0,	0,	0,	1,	1,
			1,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	1,
			1,	1,	1,	1,	1,	1,	0,	0,	0,	0,	0,	0,	0,	1,	1,	1,	0,	0,	0,	1,
			1,	1,	1,	1,	1,	1,	1,	1,	0,	0,	0,	1,	1,	1,	1,	1,	1,	0,	0,	1,
			1,	0,	0,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	0,	0,	1,
			1,	0,	0,	1,	1,	1,	0,	0,	1,	1,	1,	0,	0,	0,	0,	1,	1,	0,	0,	1,
			1,	0,	0,	1,	1,	0,	0,	0,	0,	1,	0,	0,	0,	0,	0,	1,	1,	0,	0,	1,
			1,	0,	0,	1,	0,	0,	0,	0,	0,	1,	0,	0,	0,	0,	0,	1,	1,	0,	0,	1,
			1,	0,	0,  0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	1,	0,	0,	1,
			1,	0,	0,	0,	0,	0,	1,	0,	0,	0,	0,	0,	1,	0,	0,	0,	1,	0,	0,	1,
			1,	1,	0,	0,	0,	0,	1,	1,	0,	0,	1,	1,	1,	0,	0,	0,	0,	0,	0,	1,
			1,	1,	1,	0,	0,	1,	1,	1,	1,	1,	1,	1,	1,	1,	0,	0,	0,	0,	0,	1,
			1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	0,	0,	0,	1,	1,
			1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1];

		var playerScore = 0;
		const STARTING_LIVES = 3;
    var playerLives = STARTING_LIVES;

		var showingLoseScreen = false;
		var showingWinScreen = false;

		window.onload = function() {
			canvas = document.getElementById('gameCanvas');
			canvasContext = canvas.getContext('2d');
			
			document.addEventListener('keydown', keyPressed);
			document.addEventListener('keyup', keyReleased);

			var framesPerSecond = 30;
			setInterval(function() {
				animate();
				draw();
			}, 1000/framesPerSecond);

			carReset();
		}

		carPic.src="images/car1.png";
		carPic.onload = function() {
			carPicLoaded = true;
		}

		function keyPressed(e) {
			setKeyHoldState(e.keyCode, true);

			e.preventDefault();
		}

		function keyReleased(e) {
			setKeyHoldState(e.keyCode, false);
		}

		function setKeyHoldState(keyCode,	setTo) {
			if (keyCode === KEY_UP_ARROW) {
				keyHeld_Gas	= setTo;
			}
			else if (keyCode === KEY_DOWN_ARROW) {
				keyHeld_Reverse	= setTo;
			}
			else if (keyCode === KEY_LEFT_ARROW) {
				keyHeld_TurnLeft	= setTo;
			}
			else if (keyCode === KEY_RIGHT_ARROW) {
				keyHeld_TurnRight	= setTo;
			}
		}

		function carReset() {
      if (playerLives <= 0) {
				showingLoseScreen = true;
			}

			for (var i=0; i<trackGrid.length; i++) {
				if (trackGrid[i] == TRACK_CODE_PLAYER) {
					var	row	= Math.floor(i/TRACK_COLS);
					var	col	=	i%TRACK_COLS;
					
					carX = TRACK_W * (col + 0.5);
					carY = TRACK_H * (row + 1);
					trackGrid[i] = TRACK_CODE_ROAD;
					break;
				}
			}
		}

		function isWallAtGridCoordinates(row, col) {
			var trackIndex = trackGridCoordinatesToIndex(row, col);
			return (trackGrid[trackIndex] == TRACK_CODE_WALL);
		}

		function trackGridCoordinatesToIndex(row, col) {
			return col + TRACK_COLS * row;
		}

		function checkForRoadAtPixelCoord(x, y) {
			var col = Math.floor(x/TRACK_W);
			var row = Math.floor(y/TRACK_H);

			// outside the track area - don't do anything
			if (col < 0 || col >= TRACK_COLS || row < 0 || row >= TRACK_ROWS) 
				return false;

			var trackIndex = trackGridCoordinatesToIndex(row, col);
			// return true if the track is the road
			return (trackGrid[trackIndex] === TRACK_CODE_ROAD);
		}

		function animate() {
			if(showingLoseScreen) {
				return;
			}

			if (keyHeld_Gas)	{
				carSpeed	+= DRIVE_POWER;
			}
			if (keyHeld_Reverse)	{
				carSpeed	+= -REVERSE_POWER;
			}
			if (Math.abs(carSpeed) >= MIN_TURN_SPEED) {
				if (keyHeld_TurnLeft)	{
					carAngle	+= -TURN_RATE*Math.PI;
				}
				if (keyHeld_TurnRight)	{
					carAngle	+= TURN_RATE*Math.PI;
				}
			}

			var nextCarX = carX + Math.cos(carAngle) * carSpeed;
			var nextCarY = carY + Math.sin(carAngle) * carSpeed;

			if (checkForRoadAtPixelCoord(nextCarX, nextCarY)) {
				carX = nextCarX;
				carY = nextCarY;

				carSpeed *= GROUNDSPEED_DECAY_MULT;				
			} else {
				carSpeed = -0.5*carSpeed;
			}
		}

		function draw() {	
			// background
			drawRectangle(0,0,canvas.width,canvas.height,'black');

			if(showingLoseScreen) {
				canvasContext.fillStyle = 'white';

				canvasContext.fillText("You're score: " + playerScore, 350, 200);

				canvasContext.fillText("click to continue", 350, 500);
				return;
			} else if(showingWinScreen) {
				canvasContext.fillStyle = 'white';

				canvasContext.fillText("You Win! You're score: " + playerScore, 350, 200);

				canvasContext.fillText("click to continue", 350, 500);
				return;
			}

			drawTracks();

			// car
			drawCar(carX, carY);

			canvasContext.fillStyle = 'white';
			canvasContext.fillText("Lives: " + playerLives, canvas.width - 200, 10)
			canvasContext.fillText("Score: " + playerScore, canvas.width - 100, 10)
		}

		function drawTracks()	{
			for (var i=0;	i<TRACK_ROWS;	i++) {
				for (var j=0;	j<TRACK_COLS;	j++) {
					if (isWallAtGridCoordinates(i, j)) {
						var	trackX = j * TRACK_W;
						var	trackY = i * TRACK_H + TOP_INFO_HEIGHT;

						drawRectangle(trackX,	trackY, TRACK_W - TRACK_GAP, TRACK_H - TRACK_GAP, 'blue');
					}
				}
			}
		}

		function drawCar(carX, carY) {
			if (carPicLoaded) {
				drawImageCenteredAtLocationWithRotation(carPic, carX, carY, carAngle);
			}
		}

		function drawRectangle(leftX, topY, width, height, drawColor) {
			canvasContext.fillStyle = drawColor;
			canvasContext.fillRect(leftX,topY,width,height);
		}

		function drawCircle(centerX, centerY, radius, color) {
			canvasContext.fillStyle = color;
			canvasContext.beginPath();
			canvasContext.arc(centerX, centerY, radius, 0, Math.PI*2, true)
			canvasContext.fill();
		}

		function drawImageCenteredAtLocationWithRotation(graphic, x, y, angle) {
			canvasContext.save();
			canvasContext.translate(x,y);
			canvasContext.rotate(angle);	//	sets	the	rotation
			canvasContext.drawImage(graphic,-graphic.width/2,-graphic.height/2);
			canvasContext.restore();
		}
	</script>
</body>
</html>